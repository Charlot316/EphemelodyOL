# 数据库结构

## 用户(User)

|<div style="width:100px">字段名</div>|字段含义|
|--|--|
|userId|用户ID|
|username|用户名(只能使用英文字母)|
|password|密码|
|potential|潜力值，保留两位小数，出现新的歌曲游玩记录的时候需要更新，计算方法见“附录”|
|isAdmin|是否是管理员|
|icon|头像|

## 歌曲列表(Song)

去年我写的时候同一首曲子可以有三种不同的难度(easy、difficult、hard)，我感觉太麻烦了，干脆一首曲子只有一个难度好了，easy、difficult、hard可以拆开来算作三首曲子。

|<div style="width:150px">字段名</div>|字段含义|
|--|--|
|songId|歌曲ID|
|songName|歌曲名称(不同曲子可以重名)|
|chartConstant|谱面定数(后面会介绍)，精确到一位小数|
|status|状态，一首歌曲有三种状态：保存但未发布、发布但不是认定谱面(相当于民间谱面)、认定谱面(官谱)|
|playTime|所有玩家的游玩次数(每次完整玩完了一次才+1)|
|uploaderId|上传者信息|
|songCover|存放歌曲封面图的路径|
|defaultBackground|存放歌曲的默认背景图的路径|
|notesCount|歌曲的note总数，每次上传游玩结果都要验证一下note总数是否正确，防止一些人作弊|
|loadingText|(可以为null)游戏加载的时候一般都会有一个加载的文字，玩家可以自定义这首曲子的加载文字|
|uploadDate|上传时间|
|songLength|歌曲长度（毫秒）|
|songUrl|存放歌曲音频的url|

## 谱面

谱面大体上分为3个部分：轨道(Track)、音符(Note)、操作(Operation)，但是操作又有四种操作，分别是：改变轨道横坐标、改变轨道宽度、改变轨道颜色、替换背景，前三种操作都是针对单一轨道的，最后一个操作是全局操作。

### 注意：在谱面中凡是提到“timing”，都指的是“时机”，它存下的是一个代表毫秒数的整数，而不是一个日期

### 轨道(Track)

|<div style="width:100px">字段名</div>|字段含义|
|--|--|
|songId|(外键)歌曲ID|
|trackId|轨道标号，这个id会在音符和操作中用到|
|type|轨道类别，为1的时候是实轨，为0的时候是虚轨|
|key|轨道对应的按键，一个英文字符|
|startTiming|轨道的出现时间|
|endTiming|轨道的消失时间|
|positionX|轨道横坐标，浮点数|
|width|轨道的宽度，浮点数|
|R|轨道背景颜色中的R|
|G|轨道背景颜色中的G|
|B|轨道背景颜色中的B|

### 音符(Note)

|<div style="width:100px">字段名</div>|字段含义|
|--|--|
|songId|(外键)歌曲ID，便于谱面批量删除内容|
|basedTrack|(外键)所存在的轨道的编号|
|noteType|音符类别，为0时是短按(hit)，为1时是滑键(slide)|
|key|音符对应的判定按键，一个英文字符|
|timing|音符击打的时间点|

### 操作

操作由四个表组成

#### 改变轨道横坐标(MoveOperation)

|<div style="width:100px">字段名</div>|字段含义|
|--|--|
|songId|(外键)歌曲ID，便于谱面批量删除内容|
|basedTrack|(外键)所存在的轨道的编号|
|startTime|操作开始时间|
|endTime|操作结束时间|
|startX|操作的起始坐标，浮点数|
|endX|操作的目的坐标，浮点数|

#### 改变轨道宽度(ChangeWidthOperation)

|<div style="width:100px">字段名</div>|字段含义|
|--|--|
|songId|(外键)歌曲ID，便于谱面批量删除内容|
|basedTrack|(外键)所存在的轨道的编号|
|startTime|操作开始时间|
|endTime|操作结束时间|
|startWidth|操作的起始宽度，浮点数|
|endWidth|操作的目的宽度，浮点数|

#### 改变轨道颜色(ChangeColorOperation)

|<div style="width:100px">字段名</div>|字段含义|
|--|--|
|songId|(外键)歌曲ID，便于谱面批量删除内容|
|basedTrack|(外键)所存在的轨道的编号|
|startTime|操作开始时间|
|endTime|操作结束时间|
|startR|操作的起始R|
|startG|操作的起始G|
|startB|操作的起始B|
|endR|操作的目的R|
|endG|操作的目的G|
|endB|操作的目的B|

#### 改变全局背景(ChangeBackgroundOperation)

注意这个operation没有basedTrack

|<div style="width:100px">字段名</div>|字段含义|
|--|--|
|songId|(外键)歌曲ID|
|startTime|操作开始时间|
|background|存放需要更换的背景的路径|

## 游玩结果

游玩结果分为Best和Recent两张表，他们的结构是完全一样的，但是这两张表功能是不一样的，可以看“附录”里的解释

### 最佳纪录(BestRecord)

同一组songId+userId**只能有一条数据**，它相当于存放的是每个玩家玩的某首曲子所取得的最好成绩。
当有一条新的成绩记录时，如果没有查到玩家以前没有玩过这首曲子，则直接增加这条成绩记录。如果有游玩过，而且成绩小于的成绩，则保留数据库里原来的记录；否则如果新的成绩记录的成绩大于或等于原来的成绩，则直接覆盖。

|<div style="width:100px">字段名</div>|字段含义|
|--|--|
|songId|(外键)歌曲ID|
|userId|(外键)玩家ID|
|score|游玩分数|
|pure|pure数|
|far|far数|
|lost|lost数|
|combo|combo数|
|potential|单次成绩潜力值，计算方法看“附录”|
|time|游玩的时间(这个是日期)|

### 最近记录(RecentRecord)

同一组songId+userId**可以有很多条数据**，但是同一个userId在这个表中最多只能存放10条记录。也就是说它相当于存放的是每个玩家近期玩过的曲子的记录，玩家连续打同一首曲子打了好几遍也是要存入其中的全部成绩记录的，但是总条数不超过10。
当有一条新的成绩记录时，如果表格中这个userId的记录小于10条，则直接加入。若已经有10条了，则根据time找到这10条记录中最老的记录并覆盖。

|<div style="width:100px">字段名</div>|字段含义|
|--|--|
|songId|(外键)歌曲ID|
|userId|(外键)玩家ID|
|score|游玩分数|
|pure|pure数|
|far|far数|
|lost|lost数|
|combo|combo数|
|potential|单次成绩潜力值，计算方法看“附录”|
|time|游玩的时间(这个是日期)|

## 同游房间

我的想法是做一个websocket可以允许最多4个用户一起游玩同一首曲子，并且可以实时查看别人的游玩结果(我不确定是不是需要用到数据库来实现)
感觉至少需要存下

随机生成的房间ID(4-6位数字)，
房主ID x1，
参与游玩的用户ID x1-3
每一个玩家的成绩 x2-4

## 附录

### 成绩评定

#### 分数

每一个谱面的总分都是10000000(一千万)分。因此每一个音符的最大分数都是 10000000/音符总数每一个音符的得分和判定有关。

判定为Pure的音符(偏离标准时机+-50ms以内)得分为最大分数*100%

判定为Far的音符(偏离标准时机+-100ms以内)得分为最大分数*50%

判定为Lost的音符(偏离标准时机>100ms)得分为0

最后的得分就是每一个音符的得分相加。

#### 谱面定数

每一个谱面都有一个与难度正相关的谱面定数，谱面定数越高曲子相对越难

#### 单次成绩潜力值

单次成绩潜力值是基于谱面定数和游玩的曲子的最后得分计算出来的。

 单次成绩潜力值计算表

|**分数**|**单次成绩潜力值**|
|--|--|
|10,000,000(即All Pure)|谱面定数+2|
|≥ 9,800,000 且 < 10,000,000|谱面定数+1+(分数 - 9,800,000)/200,000|
|< 9,800,000|谱面定数+(分数 - 9,500,000)/300,000 (下限为0)|

一些分数对应的单次成绩潜力值对应表

|**分数**|**单次成绩潜力值**|
|--|--|
|10,000,000|定数+2.00|
|9,950,000|定数+1.75|
|9,900,000|定数+1.50|
|9,800,000|定数+1.00|
|9,500,000|定数|
|9,200,000|定数-1.00|
|8,900,000|定数-2.00|
|8,600,000|定数-3.00|

#### 潜力值

潜力值代表一个玩家游玩音游的水平。它和经验是完全不同的概念，只要玩的时间够长，经验总会增加，但潜力值只和游玩曲目的水平好坏有关。

潜力值由两部分组成，第一部分是所有曲目中单次成绩潜力值最高的前10首(Best10，简称b10)。第二部分是最近游玩的10首曲目中，单次成绩潜力值最高的前5首(Recent5，简称r5)。这15个单次成绩潜力值取平均值。

因此潜力值可以被视为：这个玩家有潜力把定数为当前潜力值的曲子推到9500000分。比如潜力值为12.5的玩家有能力把谱面定数为12.5的歌曲的分数打到9500000。这是因为分数为9500000时得到的单次成绩潜力值就等于谱面定数。


